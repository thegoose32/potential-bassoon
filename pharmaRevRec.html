<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>pharmaRevRec</title>
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">

      const displayOptions = ['Annual', 'Quarterly'];
      const newAmounts = [
        {
          year: 0,
          quarter: 1,
          amount: 0
        },
        {
          year: 0,
          quarter: 2,
          amount: 0
        },
        {
          year: 0,
          quarter: 3,
          amount: 0
        },
        {
          year: 0,
          quarter: 4,
          amount: 0
        },
      ];

      class PharmaRevRec extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            modelName: "hello world",
            startYear: 2018,
            yearsOut: 3,
            displaySelections: [
              {
                year: 2018,
                type: "Annual"
              }, 
              {
                year: 2019,
                type: "Annual"
              },
              {
                year: 2020,
                type: "Annual"
              }
            ],
            programs: [
              {
                name: "Program A", 
                id: 1001,
                fteRate: 250000
              },
              {
                name: "Program B",
                id: 1002,
                fteRate: 250000
              }
            ],
            revenueMilestones: [
              {
                id: 1000,
                name: "Upfront Payment",
                dateEarned: "Q1 2018",
                datePaid: "Q1 2018",
                amount: 100000
              }
            ],
            externalSpend: [
              [
                {
                  year: 2018,
                  quarter: 1,
                  amount: 100
                },
                {
                  year: 2018,
                  quarter: 2,
                  amount: 100
                },
                {
                  year: 2018,
                  quarter: 3,
                  amount: 100
                },
                {
                  year: 2018,
                  quarter: 4,
                  amount: 100
                },
                {
                  year: 2019,
                  quarter: 1,
                  amount: 100
                },
                {
                  year: 2019,
                  quarter: 2,
                  amount: 100
                },
                {
                  year: 2019,
                  quarter: 3,
                  amount: 100
                },
                {
                  year: 2019,
                  quarter: 4,
                  amount: 100
                },
                {
                  year: 2020,
                  quarter: 1,
                  amount: 100
                },
                {
                  year: 2020,
                  quarter: 2,
                  amount: 100
                },
                {
                  year: 2020,
                  quarter: 3,
                  amount: 100
                },
                {
                  year: 2020,
                  quarter: 4,
                  amount: 100
                }
              ],
              [
                {
                  year: 2018,
                  quarter: 1,
                  amount: 100
                },
                {
                  year: 2018,
                  quarter: 2,
                  amount: 100
                },
                {
                  year: 2018,
                  quarter: 3,
                  amount: 100
                },
                {
                  year: 2018,
                  quarter: 4,
                  amount: 100
                },
                {
                  year: 2019,
                  quarter: 1,
                  amount: 100
                },
                {
                  year: 2019,
                  quarter: 2,
                  amount: 100
                },
                {
                  year: 2019,
                  quarter: 3,
                  amount: 100
                },
                {
                  year: 2019,
                  quarter: 4,
                  amount: 100
                },
                {
                  year: 2020,
                  quarter: 1,
                  amount: 100
                },
                {
                  year: 2020,
                  quarter: 2,
                  amount: 100
                },
                {
                  year: 2020,
                  quarter: 3,
                  amount: 100
                },
                {
                  year: 2020,
                  quarter: 4,
                  amount: 100
                }
              ]
            ],
           headcountEffort: [
              [
                {
                  year: 2018,
                  quarter: 1,
                  amount: 2
                },
                {
                  year: 2018,
                  quarter: 2,
                  amount: 2
                },
                {
                  year: 2018,
                  quarter: 3,
                  amount: 2
                },
                {
                  year: 2018,
                  quarter: 4,
                  amount: 2
                },
                {
                  year: 2019,
                  quarter: 1,
                  amount: 2
                },
                {
                  year: 2019,
                  quarter: 2,
                  amount: 2
                },
                {
                  year: 2019,
                  quarter: 3,
                  amount: 2
                },
                {
                  year: 2019,
                  quarter: 4,
                  amount: 2
                },
                {
                  year: 2020,
                  quarter: 1,
                  amount: 2
                },
                {
                  year: 2020,
                  quarter: 2,
                  amount: 2
                },
                {
                  year: 2020,
                  quarter: 3,
                  amount: 2
                },
                {
                  year: 2020,
                  quarter: 4,
                  amount: 2
                }
              ],
              [
                {
                  year: 2018,
                  quarter: 1,
                  amount: 2
                },
                {
                  year: 2018,
                  quarter: 2,
                  amount: 2
                },
                {
                  year: 2018,
                  quarter: 3,
                  amount: 2
                },
                {
                  year: 2018,
                  quarter: 4,
                  amount: 2
                },
                {
                  year: 2019,
                  quarter: 1,
                  amount: 2
                },
                {
                  year: 2019,
                  quarter: 2,
                  amount: 2
                },
                {
                  year: 2019,
                  quarter: 3,
                  amount: 2
                },
                {
                  year: 2019,
                  quarter: 4,
                  amount: 2
                },
                {
                  year: 2020,
                  quarter: 1,
                  amount: 2
                },
                {
                  year: 2020,
                  quarter: 2,
                  amount: 2
                },
                {
                  year: 2020,
                  quarter: 3,
                  amount: 2
                },
                {
                  year: 2020,
                  quarter: 4,
                  amount: 2
                }
             ]
            ]
 
          }

          //Model Setup
          this.setModelName = this.setModelName.bind(this);
          this.setStartYear = this.setStartYear.bind(this);
          this.setYearsOut = this.setYearsOut.bind(this);

          //Years Display
          this.setDisplayType = this.setDisplayType.bind(this);

          //Programs
          this.addProgram = this.addProgram.bind(this);
          this.editProgramName = this.editProgramName.bind(this);
          this.editProgramFTERate = this.editProgramFTERate.bind(this);
          this.deleteProgram = this.deleteProgram.bind(this);

          //Revenue Milestones
          this.addMilestone = this.addMilestone.bind(this);
          this.deleteMilestone = this.deleteMilestone.bind(this);
          this.editMilestoneName = this.editMilestoneName.bind(this);
          this.editMilestoneEarned = this.editMilestoneEarned.bind(this);
          this.editMilestonePaid = this.editMilestonePaid.bind(this);
          this.editMilestoneAmount = this.editMilestoneAmount.bind(this);

          //External Spend
          this.editExtSpendAmount = this.editExtSpendAmount.bind(this);

          //Headcount Effort
          this.editHeadcountEffort = this.editHeadcountEffort.bind(this);

        }

        setModelName(name) {
          this.setState({modelName: name});
        }

        setStartYear(startYear) {
          let startYearNum = Number(startYear);
          this.setState({startYear: startYearNum});
        }

        setYearsOut(yearsOut) {
          this.setState((prevState, props) => {
            let startYear = prevState.startYear;
            let extSpend = prevState.externalSpend;
            
            let newYearsOut = Number(yearsOut); 
            let displaySelections = []; 
            for (let x = 0; x < newYearsOut; x++) {
              let currentYear = startYear + x;
              displaySelections.push(
                {
                  year: currentYear,
                  type: "Annual"
                }
              );
              
            }

            let newExtSpend = extSpend.map((array) => {
              let arrayLength = editDataArrayLength(array, startYear, newYearsOut);
              return editDataArrayYears(arrayLength, startYear, newYearsOut);
            })

            return {
              yearsOut: newYearsOut,
              displaySelections: displaySelections,
              externalSpend: newExtSpend
            }
          })
        }

        setDisplayType(display, displayIndex) {
          this.setState((prevState, props) => {
            let newDisplaySelections = prevState.displaySelections;
            newDisplaySelections[displayIndex].type = display; 
            return {
              displaySelections: newDisplaySelections 
            }
          })
        }

        addProgram() {
          this.setState((prevState, props) => {
            let programArray = prevState.programs;
            let oldId = programArray[programArray.length - 1].id;
            let newId = oldId + 1;
            let newProgram = {
              name: "New Program",
              id: newId,
              fteRate: 250000
            }
            programArray.push(newProgram);

            //add external spend array//
            let newExtSpend = prevState.externalSpend;
            let startYear = prevState.startYear;
            let yearsOut = prevState.yearsOut;
            let newExtSpendArray = addDataArray(startYear, yearsOut);
            newExtSpend.push(newExtSpendArray);

            return {
              programs: programArray,
              externalSpend: newExtSpend
            }
          });
        }

        deleteProgram(programIndex) {
          this.setState((prevState, props) => {
            let programArray = prevState.programs;
            let externalSpendArray = prevState.externalSpend;
            let headcountEffortArray = prevState.headcountEffort;
            programArray.splice(programIndex, 1);
            externalSpendArray.splice(programIndex, 1);
            headcountEffortArray.splice(programIndex, 1);
            return {
              programs: programArray,
              externalSpend: externalSpendArray,
              headcountEffort: headcountEffortArray
            }
          });
        }
        
        editProgramName(programIndex, programName) {
          this.setState((prevState, props) => {
            let programArray = prevState.programs.slice();
            programArray[programIndex].name = programName;
            return {
              programs: programArray
            }
          });
        }

        editProgramFTERate(programIndex, newAmount) {
          this.setState((prevState, props) => {
            let programArray = prevState.programs.slice();
            programArray[programIndex].fteRate = newAmount;
            return {
              programs: programArray
            }
          })
        }

        addMilestone() {
          this.setState((prevState, props) => {
            let revMilestones = prevState.revenueMilestones;
            let lastId = revMilestones[revMilestones.length - 1].id;
            let newId = lastId + 1;
            let period = "Q1 " + prevState.startYear;
            let newMilestone = {
              id: newId,
              name: "New Milestone",
              dateEarned: period,
              datePaid: period,
              amount: 10000
            };
            revMilestones.push(newMilestone);
            return {
              revenueMilestones: revMilestones
            }
          })
        }

        deleteMilestone(milestoneIndex) {
          this.setState((prevState, props) => {
            let revMilestones = prevState.revenueMilestones;
            revMilestones.splice(milestoneIndex, 1);
            return {
              revenueMilestones: revMilestones
            }
          })
        }

        editMilestoneName(milestoneIndex, newName) {
          this.setState((prevState, props) => {
            let revMilestones = prevState.revenueMilestones.slice();
            revMilestones[milestoneIndex].name = newName;
            return {
              revenueMilestones: revMilestones
            }
          })
        }

        editMilestoneEarned(milestoneIndex, newDate) {
          this.setState((prevState, props) => {
            let revMilestones = prevState.revenueMilestones.slice();
            revMilestones[milestoneIndex].dateEarned = newDate;
            return {
              revenueMilestones: revMilestones
            }
          })
        }

        editMilestonePaid(milestoneIndex, newDate) {
          this.setState((prevState, props) => {
            let revMilestones = prevState.revenueMilestones.slice();
            revMilestones[milestoneIndex].datePaid = newDate;
            return {
              revenueMilestones: revMilestones
            }
          })
        }

        editMilestoneAmount(milestoneIndex, newAmount) {
          this.setState((prevState, props) => {
            let revMilestones = prevState.revenueMilestones.slice();
            revMilestones[milestoneIndex].amount = newAmount;
            return {
              revenueMilestones: revMilestones
            }
          })
        }

        editExtSpendAmount(displayType, quarter, year, newAmount, programIndex) {
          let quarterAmount = 0;
          if (displayType === "Annual") {
            quarterAmount = rounding(newAmount / 4, 100);
          } 
          this.setState((prevState, props) => {
            let extSpend = prevState.externalSpend.slice();
            let programExtSpend = extSpend[programIndex];
            let newExtSpend = programExtSpend.map((amount) => {
              if (displayType === "Annual" && amount.year === year) {
                amount.amount = quarterAmount
              } else if (displayType === "Quarterly" && amount.year === year && amount.quarter === quarter) {
                amount.amount = newAmount;
              }
              return amount;
            })
            return {
              externalSpend: extSpend
            }
          })
        }

        editHeadcountEffort(displayType, quarter, year, newAmount, programIndex) {
          let quarterAmount = 0;
          if (displayType === "Annual") {
            quarterAmount = rounding(newAmount / 4, 100);
          } 
          this.setState((prevState, props) => {
            let hcEffort = prevState.headcountEffort.slice();
            let programHcEffort = hcEffort[programIndex];
            let newHcEffort = programHcEffort.map((amount) => {
              if (displayType === "Annual" && amount.year === year) {
                amount.amount = quarterAmount;
              } else if (displayType === "Quarterly" && amount.year === year && amount.quarter === quarter) {
                amount.amount = newAmount;
              }
              return amount;
            })
            return {
              headcountEffort: hcEffort
            }
          })
        }

        render() {
        
          let totalProgramSpend = this.state.headcountEffort.map((hcEffort, progIndex) => {
            let headcountSpend = hcEffort.map((hcSpend, hcSpendIndex) => {
              let copiedHcSpend = keepCloning(hcSpend);
              copiedHcSpend.amount = rounding(copiedHcSpend.amount * this.state.programs[progIndex].fteRate, 100);
              return copiedHcSpend
            })

            let totalSpend = this.state.externalSpend[progIndex].map((extSpend, extSpendIndex) => {
              let copiedExtSpend = keepCloning(extSpend);
              copiedExtSpend.amount = rounding(extSpend.amount + headcountSpend[extSpendIndex].amount, 100);
              return copiedExtSpend;
            })
            return totalSpend;
          });

          let totalSpend = calculatePeriodTotal(totalProgramSpend);
          let grandTotal = arrayTotal(totalSpend);

          let percentComplete = totalSpend.map((period, periodIndex) => {
            let periodCopy = keepCloning(period);
            periodCopy.amount = rounding(period.amount / grandTotal, 1000000);
            return periodCopy;
          });
          let percentTotal = rounding(arrayTotal(percentComplete), 1000000);

          let dollarCompleteCum = totalSpend.map((period, periodIndex) => {
            let totalSpendThruPeriod = keepCloning(totalSpend).slice(0, periodIndex + 1);
            let cummulativeTotal = arrayTotal(totalSpendThruPeriod);
            let periodCopy = keepCloning(period);
            periodCopy.amount = cummulativeTotal;
            return periodCopy;
          });

          let percentCompleteCum = dollarCompleteCum.map((period, periodIndex) => {
            let periodCopy = keepCloning(period);
            periodCopy.amount = rounding(period.amount / grandTotal, 1000000);
            return periodCopy;
          });
          let percentTotalCum = rounding(arrayTotal(percentComplete), 1000000);


          return (
            <div>
              <ModelSetup
                modelName={this.state.modelName}
                startYear={this.state.startYear}
                setModelName={this.setModelName}
                setStartYear={this.setStartYear}
                setYearsOut={this.setYearsOut}
                yearsOut={this.state.yearsOut}
              />
              <YearDisplay
                startYear={this.state.startYear}
                yearsOut={this.state.yearsOut}
                setDisplayType={this.setDisplayType}
                displaySelections={this.state.displaySelections}
              />
              <Programs
                programs={this.state.programs}
                addProgram={this.addProgram}
                editProgramName={this.editProgramName}
                editProgramFTERate={this.editProgramFTERate}
                deleteProgram={this.deleteProgram}
              />
              <RevenueMilestones
                addMilestone={this.addMilestone}
                deleteMilestone={this.deleteMilestone}
                editMilestoneName={this.editMilestoneName}
                editMilestoneEarned={this.editMilestoneEarned}
                editMilestonePaid={this.editMilestonePaid}
                editMilestoneAmount={this.editMilestoneAmount}
                startYear={this.state.startYear}
                revenueMilestones={this.state.revenueMilestones}
                yearsOut={this.state.yearsOut}
              />
              <ExternalSpend
                startYear={this.state.startYear}
                yearsOut={this.state.yearsOut}
                displaySelections={this.state.displaySelections}
                externalSpend={this.state.externalSpend}
                programs={this.state.programs}
                editExtSpendAmount={this.editExtSpendAmount}
              />
              <HeadcountEffort
                startYear={this.state.startYear}
                yearsOut={this.state.yearsOut}
                displaySelections={this.state.displaySelections}
                headcountEffort={this.state.headcountEffort}
                programs={this.state.programs}
                editHeadcountEffort={this.editHeadcountEffort}
              />
               <HeadcountSpend
                startYear={this.state.startYear}
                yearsOut={this.state.yearsOut}
                displaySelections={this.state.displaySelections}
                headcountEffort={this.state.headcountEffort}
                programs={this.state.programs}
                editHeadcountEffort={this.editHeadcountEffort}
              />
              <TotalProgramSpend
                startYear={this.state.startYear}
                yearsOut={this.state.yearsOut}
                displaySelections={this.state.displaySelections}
                externalSpend={this.state.externalSpend}
                headcountEffort={this.state.headcountEffort}
                programs={this.state.programs}
                editHeadcountEffort={this.editHeadcountEffort}
                totalProgramSpend={totalProgramSpend}
                grandTotal={grandTotal}
                dollarCompleteCum={dollarCompleteCum}
                percentCompleteCum={percentCompleteCum}
                percentComplete={percentComplete}
                percentTotal={percentTotal}
                percentTotalCum={percentTotalCum}
                totalSpend={totalSpend}
              />
              <RevenueRecognized
                startYear={this.state.startYear}
                yearsOut={this.state.yearsOut}
                displaySelections={this.state.displaySelections}
                percentComplete={percentComplete}
                percentCompleteCum={percentCompleteCum}
                revenueMilestones={this.state.revenueMilestones}
              /> 
            </div>
          )
        }
      }
      
      class ModelSetup extends React.Component {
        constructor(props) {
          super(props) 
          this.state = {
            startYear: this.props.startYear,
            yearsOut: this.props.yearsOut,
          }
          
          this.setLocalStartYear = this.setLocalStartYear.bind(this);
          this.setLocalYearsOut = this.setLocalYearsOut.bind(this);
          this.onSubmitClick = this.onSubmitClick.bind(this);
        }

        setLocalStartYear(startYear) {
          let startYearNum = Number(startYear);
          this.setState({startYear: startYearNum});
        }

        setLocalYearsOut(yearsOut) {
          let newYearsOut = Number(yearsOut); 
          this.setState({yearsOut: newYearsOut})
        }

        onSubmitClick(event) {
          this.props.setStartYear(this.state.startYear);
          this.props.setYearsOut(this.state.yearsOut);
        }
 
        render() {
          let modelName = this.props.modelName;
          let startYear = this.props.startYear;
          let setModelName = this.props.setModelName;
          let yearsOut = this.props.yearsOut;

          return (
            <section id="Model_Setup">
              <h2>Model Setup</h2>
              <table>
                <tbody>
                  <tr>
                    <th>Model Name</th>
                    <td className="long">
                      <input
                        value={modelName}
                        onChange={(e) => setModelName(e.target.value)}
                      />
                    </td>
                  </tr>
                  <tr>
                    <th>Start Year</th>
                    <td className="long">
                      <input
                        value={this.state.startYear}
                        onChange={(e) => this.setLocalStartYear(e.target.value)}
                      />
                    </td>
                  </tr>
                  <tr>
                    <th>Years Out</th>
                    <td className="long">
                      <input
                        value={this.state.yearsOut}
                        onChange={(e) => this.setLocalYearsOut(e.target.value)}
                      />
                    </td>
                  </tr>
                </tbody>
              </table>
              <button
                onClick={(e) => this.onSubmitClick(e)}
                value="Submit"
              >Submit
              </button>
            </section>
          )
        }
      }

      function YearDisplay(props) {
        const {
          startYear,
          yearsOut,
          setDisplayType,
          displaySelections
        } = props;

        let years = yearsArray(startYear, yearsOut);
        let yearsRow = years.map((year, yearIndex) => {
          return (
            <React.Fragment key={year}>
              <tr>
                <td>{year}</td>
                <td>
                  <select
                    value={displaySelections[yearIndex].type}
                    onChange={(e) => setDisplayType(e.target.value, yearIndex)}
                  >
                    <Dropdown options={displayOptions}/>
                  </select>
                </td>
              </tr>
            </React.Fragment>
          );
        });
      
        return (
          <section id="Years_Display">
            <h2>Years Display</h2>
            <table>
              <tbody>
                <tr>
                  <th>Year</th>
                  <th>Display</th>
                </tr>
                {yearsRow}
              </tbody>
            </table>
          </section>
        )
      }

      function Programs(props) {
        const {
          programs,
          addProgram,
          editProgramName,
          editProgramFTERate,
          deleteProgram
        } = props;

        let programRows = programs.map((program, programIndex) => {
          return (
            <React.Fragment>
              <tr>
                <td>
                  <input
                    onChange={(e) => editProgramName(programIndex, e.target.value)}
                    value={program.name}
                  />
                </td>
                <td>
                  <input
                    onChange={(e) => editProgramFTERate(programIndex, e.target.value)}
                    value={program.fteRate}
                  />
                </td>
                <DeleteItem
                  removeItem={deleteProgram}
                  index={programIndex}
                />
              </tr>
            </React.Fragment>
          )
        })

        return (
          <section id="Programs">
            <h2>Programs under Revenue Model</h2>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>FTE Rate</th>
                </tr>
                <tr>
                </tr>
              </thead>
              <tbody>
                {programRows}
              </tbody>
            </table>
            <AddItem addItem={addProgram} label="Program"/>
          </section>
        )
      }

      function RevenueMilestones(props) {
        const {
          addMilestone,
          deleteMilestone,
          editMilestoneName,
          editMilestoneEarned,
          editMilestonePaid,
          editMilestoneAmount,
          startYear,
          revenueMilestones,
          yearsOut
        } = props;

        let periodSelections = periodLabels(startYear, yearsOut)

        let revenueRows = revenueMilestones.map((milestone, milestoneIndex) => {
          return (
            <React.Fragment>
              <tr>
                <td>
                  <input
                    value={milestone.name}
                    onChange={(e) => editMilestoneName(milestoneIndex, e.target.value)}
                  />
                </td>
                <td>
                  <select
                    value={milestone.dateEarned}
                    onChange={(e) => editMilestoneEarned(milestoneIndex, e.target.value)}
                  >
                    <Dropdown options={periodSelections}/>
                  </select>
                </td>
                <td>
                  <select
                    value={milestone.datePaid}
                    onChange={(e) => editMilestonePaid(milestoneIndex, e.target.value)}
                  >
                    <Dropdown options={periodSelections}/>
                  </select>
                </td>
                <td>
                  <input
                    value={milestone.amount}
                    onChange={(e) => editMilestoneAmount(milestoneIndex, e.target.value)}
                  />
                </td>
                <DeleteItem index={milestoneIndex} removeItem={deleteMilestone} />
              </tr>
            </React.Fragment>
          )
        })

        return (
          <section id="Revenue-Milestones">
            <h2>Revenue Milestones</h2>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Period Earned</th>
                  <th>Period Received</th>
                  <th>Amount</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {revenueRows}
              </tbody>
            </table>
            <AddItem addItem={addMilestone} label="Milestone"/>
          </section>
        )
      }

      function ExternalSpend (props) {
        const {
          startYear,
          yearsOut,
          displaySelections,
          externalSpend,
          programs,
          editExtSpendAmount
        } = props;

        let externalSpendRow = externalSpend.map((programSpend, programIndex) => {
          let totalProgSpend = arrayTotal(programSpend); 
          return (
            <React.Fragment>
              <tr>
                <td>{programs[programIndex].name}</td>
                <DataRows
                  startYear={startYear}
                  displaySelections={displaySelections}
                  dataArray={programSpend}
                  yearsOut={yearsOut}
                  editAmount={editExtSpendAmount}
                  programIndex={programIndex}
                  input="Yes"
                />
                <td>{totalProgSpend}</td>
              </tr>
            </React.Fragment>
          )
        });

        let totalExternalSpend = calculatePeriodTotal(externalSpend);
        let grandTotal = arrayTotal(totalExternalSpend);

        return (
          <section id="External-Spend">
            <h2>External Program Spend</h2>
            <table>
              <thead>
                <tr>
                  <th>Program</th>
                  <TablePeriodHeaders
                    startYear={startYear}
                    yearsOut={yearsOut}
                    displaySelections={displaySelections}
                  />
                  <th>Total External Spend</th>
                </tr>
              </thead>
              <tbody>
                {externalSpendRow}
                <tr>
                  <td>Total</td>
                  <TotalRows
                    displaySelections={displaySelections}
                    dataArray={totalExternalSpend}
                  />
                  <td>{grandTotal}</td>
                </tr>
              </tbody>
            </table>
          </section>
        )
      }

      function HeadcountEffort (props) {
        const {
          startYear,
          yearsOut,
          displaySelections,
          headcountEffort,
          programs,
          editHeadcountEffort
        } = props;

        let headcountEffortRow = headcountEffort.map((hcEffort, hcEffortIndex) => {
          let totalHeadcountEffort = arrayTotal(hcEffort); 
          return (
            <React.Fragment>
              <tr>
                <td>{programs[hcEffortIndex].name}</td>
                <td>{programs[hcEffortIndex].fteRate}</td>
                <DataRows
                  startYear={startYear}
                  displaySelections={displaySelections}
                  dataArray={hcEffort}
                  yearsOut={yearsOut}
                  editAmount={editHeadcountEffort}
                  programIndex={hcEffortIndex}
                  input="Yes"
                />
                <td>{totalHeadcountEffort}</td>
              </tr>
            </React.Fragment>
          )
        });

        let totalHeadcountEffort = calculatePeriodTotal(headcountEffort);
        let grandTotal = arrayTotal(totalHeadcountEffort);

        return (
          <section id="Headcount-Effort">
            <h2>Headcount Effort by Program</h2>
            <table>
              <thead>
                <tr>
                  <th>Program</th>
                  <th>FTE Rate</th>
                  <TablePeriodHeaders
                    startYear={startYear}
                    yearsOut={yearsOut}
                    displaySelections={displaySelections}
                  />
                  <th>Total Headcount Effort</th>
                </tr>
              </thead>
              <tbody>
                {headcountEffortRow}
                <tr>
                  <td>Total</td>
                  <td></td>
                  <TotalRows
                    displaySelections={displaySelections}
                    dataArray={totalHeadcountEffort}
                  />
                  <td>{grandTotal}</td>
                </tr>
              </tbody>
            </table>
          </section>
        )
      }

      function HeadcountSpend (props) {
        const {
          startYear,
          yearsOut,
          displaySelections,
          headcountEffort,
          programs,
          editHeadcountEffort
        } = props;

        let headcountEffortSpend = headcountEffort.map((hcEffort, hcEffortIndex) => {
          let headcountSpend = hcEffort.map((hcSpend, hcSpendIndex) => {
            let copiedHcSpend = keepCloning(hcSpend);
            copiedHcSpend.amount = rounding(copiedHcSpend.amount * programs[hcEffortIndex].fteRate, 100);
            return copiedHcSpend
          })
          return headcountSpend;
        });

        let headcountEffortRow = headcountEffortSpend.map((hcEffort, hcEffortIndex) => {
          let totalHeadcountEffort = arrayTotal(hcEffort); 
          return (
            <React.Fragment>
              <tr>
                <td>{programs[hcEffortIndex].name}</td>
                <td>{programs[hcEffortIndex].fteRate}</td>
                <DataRows
                  startYear={startYear}
                  displaySelections={displaySelections}
                  dataArray={hcEffort}
                  yearsOut={yearsOut}
                  input="No"
                />
                <td>{totalHeadcountEffort}</td>
              </tr>
            </React.Fragment>
          )
        });

        let totalHeadcountSpend = calculatePeriodTotal(headcountEffortSpend);
        let grandTotal = arrayTotal(totalHeadcountSpend);

        return (
          <section id="Headcount-Spend">
            <h2>Headcount Spend by Program</h2>
            <table>
              <thead>
                <tr>
                  <th>Program</th>
                  <th>FTE Rate</th>
                  <TablePeriodHeaders
                    startYear={startYear}
                    yearsOut={yearsOut}
                    displaySelections={displaySelections}
                  />
                  <th>Total Headcount Spend</th>
                </tr>
              </thead>
              <tbody>
                {headcountEffortRow}
                <tr>
                  <td>Total</td>
                  <td></td>
                  <TotalRows
                    displaySelections={displaySelections}
                    dataArray={totalHeadcountSpend}
                  />
                  <td>{grandTotal}</td>
                </tr>
              </tbody>
            </table>
          </section>
        )
      }

      function TotalProgramSpend (props) {
        const {
          startYear,
          yearsOut,
          displaySelections,
          externalSpend,
          headcountEffort,
          programs,
          editHeadcountEffort,
          totalProgramSpend,
          grandTotal,
          dollarCompleteCum,
          percentCompleteCum,
          percentComplete,
          percentTotal,
          percentTotalCum,
          totalSpend
        } = props;

        let totalProgRow = totalProgramSpend.map((totalProg, progIndex) => {
          let totalProgramSpend = arrayTotal(totalProg); 
          return (
            <React.Fragment>
              <tr>
                <td>{programs[progIndex].name}</td>
                <DataRows
                  startYear={startYear}
                  displaySelections={displaySelections}
                  dataArray={totalProg}
                  yearsOut={yearsOut}
                  input="No"
                />
                <td>{totalProgramSpend}</td>
              </tr>
            </React.Fragment>
          )
        });

        return (
          <section id="Total-Program-Spend">
            <h2>Total Program Spend</h2>
            <table>
              <thead>
                <tr>
                  <th>Program</th>
                  <TablePeriodHeaders
                    startYear={startYear}
                    yearsOut={yearsOut}
                    displaySelections={displaySelections}
                  />
                  <th>Total Program Spend</th>
                </tr>
              </thead>
              <tbody>
                {totalProgRow}
                <tr>
                  <td>Total development costs ($)</td>
                  <TotalRows
                    displaySelections={displaySelections}
                    dataArray={totalSpend}
                  />
                  <td>{grandTotal}</td>
                </tr>
                <tr>
                  <td>Total development costs (%)</td>
                  <DataRows
                    startYear={startYear}
                    displaySelections={displaySelections}
                    dataArray={percentComplete}
                    yearsOut={yearsOut}
                    input="No"
                  />
                  <td>{percentTotal}</td>
                </tr>
                <tr>
                  <td>Running total development costs ($)</td>
                  <CummulativeDataRows
                    startYear={startYear}
                    displaySelections={displaySelections}
                    dataArray={dollarCompleteCum}
                    yearsOut={yearsOut}
                    input="No"
                  />
                  <td></td>
                </tr>
                <tr>
                  <td>Running total development costs (%)</td>
                  <CummulativeDataRows
                    startYear={startYear}
                    displaySelections={displaySelections}
                    dataArray={percentCompleteCum}
                    yearsOut={yearsOut}
                    input="No"
                  />
                  <td></td>
                </tr>
              </tbody>
            </table>
          </section>
        )
      }

      function RevenueRecognized(props) {
        const {
          startYear,
          yearsOut,
          displaySelections,
          revenueMilestones,
          percentComplete,
          percentCompleteCum
        } = props;

        let milestoneRows = revenueMilestones.map((milestone, milestoneIndex) => {
          let milestoneEarnedQtr = Number(milestone.dateEarned.slice(1, 2));
          let milestoneEarnedYear = Number(milestone.dateEarned.slice(3));
          let blankDataArray = addDataArray(startYear, yearsOut);
          let milestoneRevEarned = blankDataArray.map((period, periodIndex) => {
            if (period.year === milestoneEarnedYear && period.quarter === milestoneEarnedQtr) {
              period.amount = rounding(percentCompleteCum[periodIndex].amount * milestone.amount, 10000);
              return period;
              } else if (period.year === milestoneEarnedYear && period.quarter > milestoneEarnedQtr) {
              period.amount = rounding(percentComplete[periodIndex].amount * milestone.amount, 10000);
              return period;
 
            } else if (period.year > milestoneEarnedYear) {
              period.amount = rounding(percentComplete[periodIndex].amount * milestone.amount, 10000);
              return period;
            } else {
              period.amount = 0;
              return period;
            }
          });

          let totalRevenueEarned = arrayTotal(milestoneRevEarned);

          return (
            <React.Fragment>
              <tr>
                <td>{milestone.name}</td>
                <DataRows
                  startYear={startYear}
                  displaySelections={displaySelections}
                  dataArray={milestoneRevEarned}
                  yearsOut={yearsOut}
                  input="No"
                />
                <td>{rounding(totalRevenueEarned,10)}</td>
              </tr>
            </React.Fragment>
          );
        })

        return (
          <section id="Revenue-Recognized">
            <h2>Revenue Recognized</h2>
            <table>
              <thead>
                <tr>
                  <th>Milestone</th>
                  <TablePeriodHeaders
                    startYear={startYear}
                    yearsOut={yearsOut}
                    displaySelections={displaySelections}
                  />
                  <th>Total Milestone Revenue</th>
                </tr>
              </thead>
              <tbody>
                {milestoneRows}
              </tbody>
            </table>
          </section>
        )
      }

      function Dropdown({options}) {
        let rows = options.map((x) => {
          return (
            <option value={x}>{x}</option>
          )
        })

        return (
          <React.Fragment>
            {rows}
          </React.Fragment>
        )
      }

      function DeleteItem({removeItem, index}) {
        return (
          <td className="action-cell">
            <button className="delete" onClick={(e) => {removeItem(index)}}>
              Delete
            </button>
          </td>
        )
      }

      function AddItem({addItem, label}) {
        return (
          <button onClick={addItem} className="add">{"Add " + label}</button>
        )
      }

      function TablePeriodHeaders({startYear, yearsOut, displaySelections}) {
        let labels = [];
        displaySelections.forEach((selection, selectionIndex) => {
          if (selection.type === "Annual") {
            labels.push("FY " + (startYear + selectionIndex))
          } else {
            for (let x = 1; x < 5; x++) {
              labels.push("Q" + x + " " + (startYear + selectionIndex))
            }
          }
        })
        let tableHeaders = labels.map((label) => {
          return (
            <React.Fragment>
              <th>{label}</th>
            </React.Fragment>
          )
        })
        return tableHeaders
      }

      function DataRows(props) {
        const {
          startYear,
          displaySelections,
          dataArray,
          yearsOut,
          programIndex,
          editAmount,
          input
        } = props;

        let years = yearsArray(startYear, yearsOut)
        let displayType = displayArray(displaySelections);
        let calculatedData = dataToDisplay(displayType, dataArray);
        let dataCells = calculatedData.map((cell, cellIndex) => {
          if (input === "Yes") {
            return(
              <React.Fragment>
                <td>
                  <input
                    type="number"
                    value={rounding(cell.amount,10)}
                    onChange={(e) => editAmount(cell.type, cell.quarter, cell.year, Number(e.target.value), programIndex)}
                  />
                </td>
              </React.Fragment>
            )
          } else if (input === "No") {
            return(
              <React.Fragment>
                <td>{rounding(cell.amount,10)}</td>
              </React.Fragment>
            )
          }
        })
        return dataCells;
      }

      function TotalRows(props) {
        const {
          displaySelections,
          dataArray,
        } = props;

        let displayType = displayArray(displaySelections);
        let calculatedData = dataToDisplay(displayType, dataArray);
        let dataCells = calculatedData.map((cell, cellIndex) => {
          return(
            <React.Fragment>
              <td>{rounding(cell.amount, 10)}</td>
            </React.Fragment>
          )
        })
        return dataCells;
      }

      function CummulativeDataRows(props) {
        const {
          startYear,
          displaySelections,
          dataArray,
          yearsOut,
          programIndex,
          editAmount,
          input
        } = props;

        let years = yearsArray(startYear, yearsOut)
        //Override the type to not sum in calculatedData function below//
        let displaySelectionsOverride = keepCloning(displaySelections).map((period) => {
          period.type = "Quarterly"
          return period;
        })
        let displayType = displayArray(displaySelectionsOverride);
        let calculatedData = dataToDisplay(displayType, dataArray);
        let dataCells = calculatedData.map((cell, cellIndex) => {
          let cellYear = cell.year;
          let periodDisplayCheck = displaySelections.filter(year => year.year === cellYear)
          let periodDisplay = periodDisplayCheck[0];
          if (periodDisplay.type === "Annual" && cell.quarter === 4) {
            return(
              <React.Fragment>
                <td>{rounding(cell.amount,10)}</td>
              </React.Fragment>
            )
          } else if (periodDisplay.type === "Quarterly") {
            return(
              <React.Fragment>
                <td>{rounding(cell.amount,10)}</td>
              </React.Fragment>
            )
          } else {
            return(null)
          }
        })
        return dataCells;
      }



      ReactDOM.render(
        <PharmaRevRec />,
        document.getElementById('root')
      );

      //Functions//

      function displayArray(displaySelections) {
        let displayArray = [];

        displaySelections.forEach((yearSelection) => {
          if (yearSelection.type === "Quarterly") {
            for (let x = 1; x < 5; x++) {
              let periodTotal = Object()
              periodTotal.year = yearSelection.year;
              periodTotal.quarter = x;
              periodTotal.type = yearSelection.type;
              periodTotal.amount = 0;
              displayArray.push(periodTotal);
            }
          } else if (yearSelection.type === "Annual") {
            let periodTotal = Object()
            periodTotal.year = yearSelection.year;
            periodTotal.type = yearSelection.type;
            periodTotal.amount = 0;
            displayArray.push(periodTotal);
          }
        })
        return displayArray;
      }

      function dataToDisplay(displayType, dataArray) {
        let dataRows = displayType.map((displayPeriod) => {
          dataArray.forEach((amount, amountIndex) => {
            let amountYear = amount.year;
            let amountQtr = amount.quarter;
            if (displayPeriod.year === amountYear && displayPeriod.type === "Quarterly" && displayPeriod.quarter === amountQtr) {
              displayPeriod.amount += amount.amount;
            } else if (displayPeriod.year === amountYear && displayPeriod.type === "Annual") {
              displayPeriod.amount += amount.amount;
            }
          })
          return displayPeriod;
        })

        return dataRows;
      }

      function periodLabels(startYear, yearsOut) {
        let periodLabels = [];
        for (let y = startYear; y < startYear + yearsOut; y ++) {
          for (let x = 1; x < 5; x++) {
            periodLabels.push("Q" + x + " " + y)
          }
        }
        return periodLabels
      }
 
      function displayType(props) {
        let quarterDisplay = []
        displaySelections.forEach((selection, selectionIndex) => {
          let id = 0;
          let selectionType = "Annual";
          for (let x = 1; x < 5; x++) {
            id = "" + startYear + selectionIndex;
            selectionType = selection;
            quarterDisplay.push({
              id: Number(id),
              selectionType: selectionType
            });
          }
        });
        return quarterDisplay;
      }

      function yearsArray(startYear, yearsOut) {                            
        let years = [];
        for (let x = 0; x < yearsOut; x++) {
          years.push(startYear + x)
        };
        return years
      }

      function addDataArray(startYear, yearsOut) {
        let newDataArray = [];
        for (let x = startYear; x < startYear + yearsOut; x++) {
          for (let y = 1; y < 5; y++) {
            let newCell = Object();
            newCell.year = x;
            newCell.quarter = y;
            newCell.amount = 0;
            newDataArray.push(newCell);
          }
        }
        
        return newDataArray;
      }

      function editDataArrayLength(array, startYear, yearsOut) {
        if (array.length < yearsOut * 4) {
          let newPeriods = yearsOut - (array.length / 4);
          let newDataset = [];
          for (let x = 0; x < newPeriods; x++) {
            newDataset = array.concat(keepCloning(newAmounts));
          }
          return newDataset;
        } else {
          return array;
        }
      }

      function editDataArrayYears(array, startYear, yearsOut) {
        let newYear = startYear;
        let newArray = array.map((cell, cellIndex) => {
          if (cell.quarter !== 4) {
            cell.year = startYear
          } else {
            cell.year = startYear;
            startYear += 1;
          }
          return cell;
        });

        return newArray;
      }

      function arrayTotal(array) {
        let initialTotal = 0;
        let total = array.reduce((a, b) => a + b.amount, initialTotal);
        return total;
      }

      function calculatePeriodTotal(arrayOfArrays) {
        if (arrayOfArrays.length === 1) {
          return keepCloning(arrayOfArrays[0]);
        } else if (arrayOfArrays.length > 1) {
          let totalArray = [];
          arrayOfArrays.forEach((array, arrayIndex) => {
            if (arrayIndex === 0) {
              return totalArray = keepCloning(array);
            } else {
              array.forEach((cell, cellIndex) => {
                return totalArray[cellIndex].amount += cell.amount
              })
            }
          })
          return totalArray;
        }
      }

      function keepCloning(objectpassed) {
        if (objectpassed === null || typeof objectpassed !== 'object') {
          return objectpassed;
        }

      var temporaryStorage = objectpassed.constructor();
        for (var key in objectpassed) {
          temporaryStorage[key] = keepCloning(objectpassed[key]);
        }
        return temporaryStorage;
      }

      function rounding(input, decimals) {
        let roundNumber = Math.round(input * decimals) / decimals;
        return roundNumber;
      }


    </script>
    <!--
      Note: this page is a great way to try React but it's not suitable for production.
      It slowly compiles JSX with Babel in the browser and uses a large development build of React.

      To set up a production-ready React build environment, follow these instructions:
      * https://reactjs.org/docs/add-react-to-a-new-app.html
      * https://reactjs.org/docs/add-react-to-an-existing-app.html

      You can also use React without JSX, in which case you can remove Babel:
      * https://reactjs.org/docs/react-without-jsx.html
      * https://reactjs.org/docs/cdn-links.html
    -->
  </body>
</html>
